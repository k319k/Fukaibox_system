# **封解Box 完全設計仕様書 (React \+ HeroUI Edition)**

## **1\. システムアーキテクチャ (The Triple DB Strategy)**

「確実に動くWebベースの最高峰」を目指し、ReactとHeroUIを中核に据えた構成。

### **1.1 公開設定・ネットワーク**

* **公開ドメイン**: fukaibox.kanjousekai.jp  
* **公開手段**: **Cloudflare Tunnel**  
  * メリット: ローカル（Raspberry Pi）環境を安全に外部公開し、SSL/TLS暗号化とDDoS保護を標準適用。

### **1.2 バックエンド (Backend Server)**

* **言語**: **Python 3.10+**  
* **Framework**: **FastAPI**  
  * 選定理由: 低メモリ（RPi向け）、Pillowによる高度な画像処理、Tools（Sandbox）との親和性。  
* **Server DB**: **PostgreSQL** (Docker/RPi環境)  
  * 役割: 点数履歴、APIキー、シート原典、Tools管理データの永続化。  
* **Real-time**: **WebSocket** \+ **Firebase (Firestore)**  
  * 役割: クライアント間のリアルタイム同期。

### **1.3 フロントエンド (Web App)**

* **Framework**: **React (JavaScript)**  
* **UI Library**: **HeroUI (旧NextUI)** \+ **Tailwind CSS**  
* **State Management**: **Zustand** (ストア分割による大整理の維持)  
* **Local DB**: **IndexedDB (Dexie.js)**  
  * 役割: オフライン閲覧、投稿下書き、Toolsのソースコード保存。

## **2\. デザイン・システム (Akane & Modern)**

HeroUIの洗練されたコンポーネントに、和の美学を統合する。

* **Primary (茜色)**: \#B3424A (HeroUIの primary カラー)  
* **Secondary (濃紅)**: \#9e2b1f (募集停止・エラー用)  
* **Surface (和紙色)**: \#fdfaf5 (Card/Modalの背景。backdrop-blurを多用)  
* **Text (墨色)**: \#121212  

## **3\. API 詳細仕様**

### **3.1 儀員点数API (Public / X-API-KEY)**

| Endpoint | Method | Description |
| :---- | :---- | :---- |
| /v1/public/points/{uid} | GET | 点数・ランク照会 |
| /v1/public/points/adjust | POST | 点数増減 (理由必須) |
| /v1/public/points | PUT | 投稿/採用時の報酬点数設定の変更 |
| /v1/public/users/list | GET | 封解ペンネーム形式のランキング取得 |

### **3.2 システム内部API (Internal / JWT)**

| Category | Endpoint | Method | Description |
| :---- | :---- | :---- | :---- |
| **Auth** | /auth/discord | GET | Discord認証 & 儀長判定 |
| **Sheets** | /sheets | GET/POST | 一覧取得 / 新規作成 |
|  | /sheets/{id}/script | PUT | 台本・指示更新 & FirestoreへSync |
| **Images** | /sheets/{id}/upload | POST | **Pillowによる 640x480 Center Crop 実行** |
|  | /images/{id}/adopt | POST | 画像採用（複数可） & 点数自動加算 |
| **Tools** | /tools/projects | GET/POST | Toolsプロジェクト管理 |
|  | /tools/run/{id} | POST | サーバー側プロセス開始（最大3件制限） |
| **Export** | /sheets/{id}/export | GET | 採用画像のZIP生成（リサイズ済み） |

## **4\. 封解Box Tools (Sandbox)**

* **リソース**: 1人 **2GB** (ファイル・フォルダ無制限) / **常時実行 3プロジェクト** まで。  
* **実行環境**:  
  * **Front**: iframe (sandbox属性) \+ srcdoc 方式。  
  * **Back**: Pythonの subprocess または Dockerコンテナによるプロセス隔離。  
* **通信許可**: Firebase, Discord, YouTube, Gemini, GPT, GDrive, GitHub, Wikipedia, 儀員点数API。

## **5\. 同期・整理規約 (AI Agent への掟)**

1. **Zustandストア分割**: sheetStore.js, pointStore.js, toolsStore.js にファイルを分けること。  
2. **HeroUI活用**: Card, Button, Modal, Navbar はHeroUIをベースに、茜色のアクセントを加えること。  
3. **JS整理**: TypeScriptを避ける分、Prop-Typesや詳細なコメントで引数の型を明記せよ。  
4. **1ファイル限界**: 1コンポーネントは **200行** を超えたら即座にサブコンポーネントへ分割せよ。

## **6\. プロジェクト構造**

/  
├── backend/                \# FastAPI \+ PostgreSQL  
│   ├── app/  
│   │   ├── models/         \# PostgreSQL Schema  
│   │   ├── api/            \# Endpoints  
│   │   └── services/       \# Image processing, Firebase sync  
├── frontend/               \# React \+ HeroUI (JavaScript)  
│   ├── src/  
│   │   ├── components/     \# UI Parts  
│   │   ├── store/          \# Zustand  
│   │   └── services/       \# API, Firebase client  
└── deploy/  
    ├── deploy-rpi.bat      \# npm build & RPi sync  
    └── cloudflared/        \# Cloudflare Tunnel 構成ファイル

## **7\. 実装・デプロイガイド**

* **ドメイン**: fukaibox.kanjousekai.jp  
* **デプロイ**: Raspberry Pi 上で cloudflared を実行し、ローカルの FastAPI (8000番ポート) および Webサーバー (80番ポート) を公開せよ。  
* **リサイズ**: 640x480リサイズは「サーバーの責任」とし、クライアント側の負荷を最小限にせよ。
